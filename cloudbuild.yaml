# Cloud Build template â€” customize _REGION, _SERVICE_NAME, and secrets mapping
substitutions:
  _REGION: europe-west1
  _SERVICE_NAME: <PROJECT_NAME>
  _IMAGE: 'europe-west1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/<PROJECT_NAME>:$SHORT_SHA'

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/SUPABASE_URL/versions/latest
      env: SUPABASE_URL
    - versionName: projects/$PROJECT_ID/secrets/SUPABASE_ANON_KEY/versions/latest
      env: SUPABASE_ANON_KEY

steps:
  - name: 'gcr.io/cloud-builders/bash'
    id: 'Validate secrets'
    secretEnv: ['SUPABASE_URL','SUPABASE_ANON_KEY']
    entrypoint: 'bash'
    args:
      - -lc
      - |
        set -euo pipefail
        if [[ -z "${SUPABASE_URL}" ]]; then echo 'ERROR: SUPABASE_URL is empty (Secret missing?)'; exit 1; fi
        if [[ -z "${SUPABASE_ANON_KEY}" ]]; then echo 'ERROR: SUPABASE_ANON_KEY is empty (Secret missing?)'; exit 1; fi
        echo 'Secrets present: SUPABASE_URL and SUPABASE_ANON_KEY'
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build image'
    entrypoint: 'bash'
    secretEnv: ['SUPABASE_URL','SUPABASE_ANON_KEY']
    args:
      - -c
      - |
        docker build \
          --build-arg SUPABASE_URL=$$SUPABASE_URL \
          --build-arg SUPABASE_ANON_KEY=$$SUPABASE_ANON_KEY \
          -t ${_IMAGE} .

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push image'
    args: ['push', '${_IMAGE}']

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Deploy to Cloud Run'
    args:
      - run
      - deploy
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_IMAGE}'
      - '--region'
      - '${_REGION}'
      - '--allow-unauthenticated'

images:
  - '${_IMAGE}'


